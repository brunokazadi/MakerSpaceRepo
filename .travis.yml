language: ruby
rvm:
- 2.3.1

services:
- postgresql

before_script:
- psql -c 'create database makerspacerepo;' -U postgres
- openssl req -x509 -newkey rsa:4096 -keyout certs/saml.key -out certs/saml.crt -days
  1 -nodes -subj "/C=CA/ST=Ontario/L=Ottawa/O=uOttawa/OU=Richard L'Abb√© Makerspace/CN=makerepo.com/emailAddress=travis-ci@makerepo.com"

jobs:
  include:
  - stage: test
    name: Test
    script:
    - bundle exec rake db:migrate RAILS_ENV=test
    - bundle exec rake test RAILS_ENV=test
  - stage: deploy
    name: Deploy
    script:
    - openssl aes-256-cbc -k $DEPLOY_KEY -d -a -in config/deploy_id_rsa_enc_travis
      -out config/deploy_id_rsa
    - chmod 600 config/deploy_id_rsa
    - eval "$(ssh-agent -s)"
    - cat config/deploy_id_rsa
    - ssh-add config/deploy_id_rsa
    - bundle exec cap staging deploy

stages:
- name: deploy
  if: branch = travis-auto-deploy

env:
  global:
    secure: k0jpb427qmNuH8qLoXxQHjAbwbB4n9B5RM5d/JtbYOfpY9i5jgWQ/hMSk/L4CGz8becuK7TUZRwbFNcATecL9VlOuHyHv98+V3N4FvvoqEPfkcfwlzU43uN+Hi+HAV/RMlGwoBLHBmgf3tRFsuEvxU1IS2FuvNsE4pnX/56UI0uHttcvFFnE9KQoDS0Ir8t4glofGARz42xE5rdtXIcxbgcdBtX8M/ojv6MvFJCcGldGmkphL2n7c6hEf79i7DqpFK47oi1Eksz7WWaiqW26W/40e9ih0ESBU12Yt+u4QGvUQk5MbHCHpEbPavs2RVgIi/9Qyq7Uvvn4qv/jOjlDLO4CLaloGOOU/hVDDICItWlNalccE2TDE8/KSM9NdJwXWRzo7zI0E/7BDdITYUYhM29jheILpW8eZlr0LCiAay92DHNGVBbGJ46wLKjMR0rSTT47v6WPnKdvvomt6E4Y7VYHv3zf09nNw/oBqJ80PjK7KMZzV37xjFSJCL6UBCCulDSYE2tYT2Bb98+FsQ0u9pRc0JkMS5R8DAUr/VZuKwvxpG7qceEoHag4gGZb3wHQqcmcWuM0JFsbYOM6Bbe8Zd2rHaUH6V9EsQoWUPqQ0iH9muTaztFLLT6CBku4aL5lqd8luhB6sCWQ27P4LF1K3unCV0GFAcDAMXRH7sDhlnI=
